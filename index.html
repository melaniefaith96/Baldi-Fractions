<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fraction Run</title>
<style>
body {
    margin:0;
    font-family:sans-serif;
    background:#111;
    color:#eee;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
#game {width:90%;max-width:800px;}
header {display:flex;justify-content:space-between;padding:10px;}
.scene {
    position:relative;
    background:#000;
    height:300px;
    margin:10px 0;
    overflow:hidden;
    border:2px solid #444;
    border-radius:8px;
}
#door {
    position:absolute;
    bottom:0;
    right:50px;
    width:60px;
    height:100px;
    background:brown;
    border:3px solid #663300;
    transition:transform 0.3s;
}
#player {
    position:absolute;
    bottom:0;
    left:10px;
    width:40px;
    height:60px;
    background:blue;
    border-radius:10px;
    animation:run 0.5s infinite alternate;
}
#monster {
    position:absolute;
    bottom:0;
    left:-50px;
    width:40px;
    height:60px;
    background:red;
    border-radius:10px;
    animation:monsterRun 1s infinite alternate;
}
@keyframes run {
    0% {bottom:0;}
    50% {bottom:5px;}
    100% {bottom:0;}
}
@keyframes monsterRun {
    0% {bottom:0;}
    50% {bottom:10px;}
    100% {bottom:0;}
}
.fraction-box {background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:10px;}
#fractionPrompt {font-size:2rem;text-align:center;margin-bottom:10px;}
input {width:80px;padding:5px;margin-right:10px;}
button {padding:5px 10px;cursor:pointer;}
#message {margin-top:8px;text-align:center;color:#ff6b6b;}
.controls {margin-top:10px;display:flex;gap:10px;justify-content:center;}
.door-open{transform:translateY(-10px);}
.timer-low{color:red;}
#gameOver {display:none;text-align:center;font-size:2rem;margin-top:20px;color:red;}
.correct-flash {animation:flashGreen 0.5s;}
.wrong-flash {animation:flashRed 0.5s;}
@keyframes flashGreen {0%{background:#000}50%{background:#0f0}100%{background:#000}}
@keyframes flashRed {0%{background:#000}50%{background:#f00}100%{background:#000}}
</style>
</head>
<body>
<div id="game">
    <header>
        <h1>Fraction Run</h1>
        <div id="timer">Time: <span id="time">20</span>s</div>
        <div id="score">Score: 0</div>
    </header>

    <main>
        <div class="scene">
            <div id="door"></div>
            <div id="player"></div>
            <div id="monster"></div>
        </div>

        <div class="fraction-box">
            <div id="fractionPrompt"> ? / ? = ?</div>
            <input id="answerInput" type="number" placeholder="Reduced numerator">
            <button id="submitBtn">Submit</button>
            <div id="message"></div>
        </div>

        <div class="controls">
            <button id="startBtn">Start Game</button>
        </div>

        <div id="gameOver">Game Over! Press Start to Retry</div>
    </main>
</div>

<script>
// Game elements
const fractionPrompt = document.getElementById('fractionPrompt');
const answerInput = document.getElementById('answerInput');
const submitBtn = document.getElementById('submitBtn');
const startBtn = document.getElementById('startBtn');
const message = document.getElementById('message');
const timeEl = document.getElementById('time');
const scoreEl = document.getElementById('score');
const player = document.getElementById('player');
const door = document.getElementById('door');
const monster = document.getElementById('monster');
const gameOverEl = document.getElementById('gameOver');

let currentFraction = {n:0,d:1};
let reducedFraction = {n:0,d:1};
let timer = null;
let timeLeft = 20;
let score = 0;
let playing = false;
let monsterSpeed = 300;

// Web Audio for spooky background
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let oscillator = null;

function playSpookySound() {
    if(oscillator) oscillator.stop();
    oscillator = audioCtx.createOscillator();
    oscillator.type = 'sawtooth';
    oscillator.frequency.setValueAtTime(110, audioCtx.currentTime);
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.02;
    oscillator.connect(gainNode).connect(audioCtx.destination);
    oscillator.start();
}

function stopSpookySound() {
    if(oscillator) oscillator.stop();
    oscillator = null;
}

// Utilities
function gcd(a,b){return b===0?a:gcd(b,a%b);}
function reduceFraction(n,d){const g=gcd(n,d); return {n:n/g,d:d/g};}

// Random fraction, difficulty scales
function randomFraction(){
    let max = 10 + Math.min(score*2, 10);
    const n=Math.floor(Math.random()*max)+2;
    const d=Math.floor(Math.random()*max)+2;
    return {n,d};
}

function updatePrompt(){
    fractionPrompt.textContent=`${currentFraction.n}/${currentFraction.d} = ?`;
}

// Timer with monster movement
function startTimer(){
    clearInterval(timer);
    timer=setInterval(()=>{
        timeLeft--;
        timeEl.textContent=timeLeft;
        if(timeLeft<=5) timeEl.classList.add('timer-low'); else timeEl.classList.remove('timer-low');
        monster.style.left=`${-50 + (1-(timeLeft/20))*monsterSpeed}px`;
        if(timeLeft<=0){
            clearInterval(timer);
            playing=false;
            message.textContent="The monster caught you!";
            gameOverEl.style.display = 'block';
            stopSpookySound();
        }
        // Door shakes if monster very close
        if(parseInt(monster.style.left) > parseInt(door.style.right) - 70){
            door.style.transform='translateY(-5px)';
            setTimeout(()=>door.style.transform='translateY(0px)',100);
        }
    },1000);
}

function newRound(){
    currentFraction=randomFraction();
    reducedFraction=reduceFraction(currentFraction.n,currentFraction.d);
    updatePrompt();
    answerInput.value='';
    timeLeft=20;
    timeEl.textContent=timeLeft;
    player.style.left='10px';
    monster.style.left='-50px';
    monsterSpeed = 300 + score*10;
    door.classList.remove('door-open');
    message.textContent='';
    startTimer();
}

// Handle submit
submitBtn.addEventListener('click',()=>{
    if(!playing) return;
    const ans=parseInt(answerInput.value);
    if(ans===reducedFraction.n){
        message.textContent="Correct! Door opens!";
        fractionPrompt.classList.add('correct-flash');
        setTimeout(()=>fractionPrompt.classList.remove('correct-flash'),500);
        door.classList.add('door-open');
        score++;
        scoreEl.textContent=score;
        player.style.left='200px';
        clearInterval(timer);
        setTimeout(()=>{if(playing)newRound();},800);
    }else{
        message.textContent=`Wrong! Try again.`;
        fractionPrompt.classList.add('wrong-flash');
        setTimeout(()=>fractionPrompt.classList.remove('wrong-flash'),500);
        timeLeft=Math.max(0,timeLeft-3);
        timeEl.textContent=timeLeft;
    }
});

// Keyboard movement
document.addEventListener('keydown', e=>{
    if(!playing) return;
    let left = parseInt(player.style.left);
    if(e.key==='ArrowRight') player.style.left = Math.min(left+20, 250)+'px';
    if(e.key==='ArrowLeft') player.style.left = Math.max(left-20, 0)+'px';
});

startBtn.addEventListener('click',()=>{
    if(audioCtx.state === 'suspended') audioCtx.resume(); // allow audio in browsers
    playSpookySound();
    gameOverEl.style.display='none';
    playing=true;
    score=0;
    scoreEl.textContent=score;
    newRound();
});
</script>
</body>
</html>
